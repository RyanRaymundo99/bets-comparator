generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTHENTICATION MODELS
// ========================================

model User {
  id              String           @id @map("_id")
  name            String
  email           String           @unique
  password        String?
  emailVerified   Boolean          @default(false)
  role            UserRole         @default(CLIENT)
  image           String?
  createdAt       DateTime
  updatedAt       DateTime
  accounts        Account[]
  sessions        Session[]
  comparisons     Comparison[]
  userBets        UserBet[] // User's linked bets with their parameters
  betLinkRequests BetLinkRequest[] // User's bet linking requests

  @@map("user")
}

model Session {
  id        String   @id @map("_id")
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id @map("_id")
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id          String           @id @map("_id")
  identifier  String // email
  value       String // verification code
  type        VerificationType // EMAIL or PASSWORD_RESET
  purpose     String? // Additional context like "signup", "password_reset"
  attempts    Int              @default(0)
  maxAttempts Int              @default(3)
  expiresAt   DateTime
  createdAt   DateTime?        @default(now())
  updatedAt   DateTime?        @updatedAt

  @@map("verification")
}

enum VerificationType {
  EMAIL
  PASSWORD_RESET
}

enum UserRole {
  ADMIN
  CLIENT
}

// ========================================
// BETS COMPARATOR MODELS
// ========================================

model Bet {
  id           String           @id @default(cuid())
  betId        String?          @unique // Unique Bet ID like "UF87F" - required for user linking
  name         String
  company      String? // Company name (e.g., "PIXBET SOLUÇÕES TECNOLÓGICAS LTDA")
  domain       String?          @unique // Main domain (e.g., "pix.bet.br")
  cnpj         String? // CNPJ if available
  url          String? // Website URL
  logo         String? // Logo image path (rounded)
  coverImage   String? // Cover image path (like Facebook cover)
  region       String? // Region/scope (kept for compatibility)
  license      String? // License info (kept for compatibility)
  status       String?          @default("Funcionando") // Funcionando, Fora do ar, etc
  scope        String? // Brasil or Mundial
  platformType String? // Casino, Sports, Ambos
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  parameters   Parameter[] // Admin-defined parameters (template)
  userBets     UserBet[] // User instances of this bet
  linkRequests BetLinkRequest[] // Link requests for this bet

  @@map("bet")
}

model Parameter {
  id       String  @id @default(cuid())
  betId    String
  name     String
  category String? // Category from parameter definitions

  // Different value types to support all parameter types
  valueText    String? // For text values
  valueNumber  Decimal? @db.Decimal(20, 2) // For numeric values
  valueBoolean Boolean? // For yes/no values
  valueRating  Int? // For star ratings (0-5)

  unit        String? // e.g., "R$", "%", "score"
  description String?  @db.Text // Longer descriptions
  type        String? // "text", "number", "currency", "boolean", "rating", "percentage", "select"
  options     String[] // For select type parameters

  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt
  bet       Bet                @relation(fields: [betId], references: [id], onDelete: Cascade)
  history   ParameterHistory[]

  @@unique([betId, name])
  @@map("parameter")
}

model ParameterHistory {
  id          String @id @default(cuid())
  parameterId String

  // Store all value types for history
  valueText    String?
  valueNumber  Decimal? @db.Decimal(20, 2)
  valueBoolean Boolean?
  valueRating  Int?

  notes     String?   @db.Text // Optional notes about why the value changed
  createdAt DateTime  @default(now())
  parameter Parameter @relation(fields: [parameterId], references: [id], onDelete: Cascade)

  @@map("parameter_history")
}

model UserBet {
  id         String          @id @default(cuid())
  userId     String
  betId      String // Reference to the Bet (admin-created)
  bet        Bet             @relation(fields: [betId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  parameters UserParameter[] // User's own parameter values for this bet

  @@unique([userId, betId]) // One user can only link to a bet once
  @@map("user_bet")
}

model UserParameter {
  id        String  @id @default(cuid())
  userBetId String
  name      String // Parameter name (matches admin parameter name)
  category  String? // Category from parameter definitions

  // Different value types to support all parameter types
  valueText    String? // For text values
  valueNumber  Decimal? @db.Decimal(20, 2) // For numeric values
  valueBoolean Boolean? // For yes/no values
  valueRating  Int? // For star ratings (0-5)

  unit        String? // e.g., "R$", "%", "score"
  description String?  @db.Text
  type        String? // "text", "number", "currency", "boolean", "rating", "percentage", "select"
  options     String[] // For select type parameters

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  userBet   UserBet  @relation(fields: [userBetId], references: [id], onDelete: Cascade)

  @@unique([userBetId, name]) // One parameter per name per user bet
  @@map("user_parameter")
}

model Comparison {
  id           String   @id @default(cuid())
  userId       String
  name         String? // Optional name for saved comparisons
  selectedBets String[] // Array of bet IDs or userBet IDs
  filters      Json? // Store filter settings
  insights     String? // AI-generated insights
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("comparison")
}

model BetLinkRequest {
  id          String        @id @default(cuid())
  userId      String
  betId       String // Reference to the Bet (admin-created)
  status      RequestStatus @default(PENDING) // PENDING, APPROVED, REJECTED
  requestedAt DateTime      @default(now())
  reviewedAt  DateTime?
  reviewedBy  String? // Admin user ID who reviewed
  notes       String?       @db.Text // Optional notes from admin
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  bet         Bet           @relation(fields: [betId], references: [id], onDelete: Cascade)

  @@unique([userId, betId]) // One pending request per user per bet
  @@map("bet_link_request")
}

enum RequestStatus {
  PENDING
  APPROVED
  REJECTED
}
